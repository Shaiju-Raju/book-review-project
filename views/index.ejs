<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Book Review Collection</title>
    <link rel="stylesheet" href="/css/style.css" />

</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="logo-section">
                <h1 class="logo">üìö Book Reviews</h1>
                <p class="tagline">A Design DIY Collection</p>
            </div>
            <nav class="nav-menu">
                <a href="#home" class="nav-link active">HOME</a>
                <a href="/new-review" class="nav-link">NEW REVIEW</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-container">
        <section class="hero">
            <h2 class="hero-title">Book Review Collection</h2>
            <p class="hero-subtitle">Discover amazing books and share your thoughts</p>
        </section>

        <section class="filters">
            <div class="search-box">
                <input type="text" placeholder="Search books..." class="search-input" />
                <button class="search-btn">üîç</button>
            </div>
            <div class="sort-options">
                <label for="sort-select">Sort by:</label>
                <select id="sort-select" class="sort-select">
                    <option>All Posts</option>
                    <option>Title</option>
                    <option>Rating</option>
                    <option>Latest</option>
                </select>
            </div>
        </section>

        <!-- Book Cards Grid -->
        <section class="books-grid">
            <% book_review.forEach(item => { %>
                
            
            <article class="book-card" data-id="card-1">
                <div class="card-image-container">
                    <img src="https://via.placeholder.com/300x400/FF6B6B/ffffff?text=Book+1" alt="Book Cover" class="book-image" />
                </div>
                <div class="card-content">
                    <div class="card-header">
                        <div class="author-info">
                            <div>
                                <p class="card-author"><%= item.author %></p>
                                <p class="card-rating">‚≠ê <%= item.rating %>/10</p>
                            </div>
                        </div>
                        <div class="card-actions">
                            <form action="/edit/<%= item.id %>" method="get">
                            <button type="submit" class="edit-btn" title="Edit">‚úèÔ∏è</button>
                            </form>

                            <form action="/delete/<%= item.id %>" method="post">
                            <button type="submit" class="delete-btn" title="Delete">üóëÔ∏è</button>
                            </form>
                        </div>
                    </div>
                    <h3 class="book-title"><%= item.title %></h3>
                    <p class="book-review">
                        <%= item.review %>
                    </p>
                </div>
            </article>

            
            <% }); %>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2024 Book Review Collection. All rights reserved.</p>
    </footer>

    <script>
        // Apply result from form.ejs (edit or new)
        (function applyFormResult(){
            try {
                const raw = localStorage.getItem('formResult');
                if (!raw) return;
                const data = JSON.parse(raw);
                if (!data) {
                    localStorage.removeItem('formResult');
                    return;
                }

                // If editing existing card
                if (data.id) {
                    const card = document.querySelector(`[data-id="${data.id}"]`);
                    if (card) {
                        const titleEl = card.querySelector('.book-title');
                        const authorEl = card.querySelector('.card-author');
                        const ratingEl = card.querySelector('.card-rating');
                        const reviewEl = card.querySelector('.book-review');
                        const imageEl = card.querySelector('.book-image');

                        if (titleEl && data.title) titleEl.textContent = data.title;
                        if (authorEl && data.author) authorEl.textContent = data.author;
                        if (ratingEl && data.rating) ratingEl.textContent = `‚≠ê ${data.rating}/10`;
                        if (reviewEl && data.review) reviewEl.textContent = data.review;
                        if (imageEl && data.image) imageEl.src = data.image;
                    }
                } else {
                    // If creating new card
                    const booksGrid = document.querySelector('.books-grid');
                    if (booksGrid) {
                        const newId = 'card-' + Date.now();
                        const newCard = document.createElement('article');
                        newCard.className = 'book-card';
                        newCard.setAttribute('data-id', newId);
                        newCard.innerHTML = `
                            <div class="card-image-container">
                                <img src="${data.image || 'https://via.placeholder.com/300x400/95E1D3/ffffff?text=New+Book'}" alt="Book Cover" class="book-image" />
                            </div>
                            <div class="card-content">
                                <div class="card-header">
                                    <div class="author-info">
                                        <div>
                                            <p class="card-author">${data.author || 'Unknown'}</p>
                                            <p class="card-rating">‚≠ê ${data.rating || '0'}/10</p>
                                        </div>
                                    </div>
                                    <div class="card-actions">
                                        <button class="edit-btn" title="Edit">‚úèÔ∏è</button>
                                        <button class="delete-btn" title="Delete">üóëÔ∏è</button>
                                    </div>
                                </div>
                                <h3 class="book-title">${data.title || 'New Review'}</h3>
                                <p class="book-review">${data.review || ''}</p>
                            </div>
                        `;
                        booksGrid.insertBefore(newCard, booksGrid.firstChild);
                    }
                }
                // clear result after applying
                localStorage.removeItem('formResult');
            } catch (err) {
                console.error('applyFormResult error', err);
                localStorage.removeItem('formResult');
            }
        })();

        // Event delegation on the books grid to handle edit and delete actions
        const booksGrid = document.querySelector('.books-grid');

        booksGrid && booksGrid.addEventListener('click', function(e) {
            // const deleteBtn = e.target.closest('.delete-btn');
            const editBtn = e.target.closest('.edit-btn');

            // if (deleteBtn) {
            //     const card = deleteBtn.closest('.book-card');
            //     if (!card) return;
            //     if (confirm('Are you sure you want to delete this review?')) {
            //         card.remove();
            //     }
            //     return;
            // }

            if (editBtn) {
                const card = editBtn.closest('.book-card');
                if (!card) return;

                const id = card.getAttribute('data-id') || '';
                const titleEl = card.querySelector('.book-title');
                const authorEl = card.querySelector('.card-author');
                const ratingEl = card.querySelector('.card-rating');
                const reviewEl = card.querySelector('.book-review');
                const imageEl = card.querySelector('.book-image');

                const payload = {
                    id: id,
                    title: titleEl ? titleEl.textContent.trim() : '',
                    author: authorEl ? authorEl.textContent.trim() : '',
                    rating: ratingEl ? (ratingEl.textContent.replace(/[^0-9]/g, '') || '') : '',
                    review: reviewEl ? reviewEl.textContent.trim() : '',
                    image: imageEl ? imageEl.src : ''
                };

                // save to localStorage and navigate to form page (edit mode)
                try {
                    localStorage.setItem('formData', JSON.stringify(payload));
                    localStorage.setItem('formMode', 'edit');
                    window.location.href = 'form.ejs';
                } catch (err) {
                    console.error('Unable to open edit page', err);
                }
            }
        });
    </script>
</body>
</html>